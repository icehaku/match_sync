(function(){var $;$=jQuery,this.Sync={ready:!1,readyQueue:[],FAYE_HOST:"http://localhost:9292/faye",PUSHER_API_KEY:"",CLIENT_ADAPTER:"Faye",init:function(){return this.adapter=new Sync[this.CLIENT_ADAPTER],$(function(t){return function(){return t.isReady()?void 0:(t.ready=!0,t.connect(),t.flushReadyQueue(),t.bindUnsubscribe())}}(this))},bindUnsubscribe:function(){return $(document).bind("page:fetch",function(t){return function(){return t.adapter.unsubscribeAll()}}(this)),$(document).bind("page:restore",function(t){return function(){return t.reexecuteScripts()}}(this))},reexecuteScripts:function(){var i,len,ref,results,script;for(ref=$("script[data-sync-id]"),results=[],i=0,len=ref.length;len>i;i++)script=ref[i],results.push(eval($(script).html()));return results},onConnectFailure:function(t){},connect:function(){return this.adapter.connect()},isConnected:function(){return this.adapter.isConnected()},onReady:function(t){return this.isReady()?t():this.readyQueue.push(t)},flushReadyQueue:function(){var t,e,n,r;for(r=this.readyQueue,e=0,n=r.length;n>e;e++)t=r[e],this.onReady(t);return this.readyQueue=[]},isReady:function(){return this.ready},camelize:function(t){return t.replace(/(?:^|[-_])(\w)/g,function(t,e){var n;return null!=(n=null!=e?e.toUpperCase():void 0)?n:""})},viewClassFromPartialName:function(t,e){var n,r;return null!=(n=null!=(r=Sync[this.camelize(e+"_"+t)])?r:Sync[this.camelize(t)])?n:Sync.View}},Sync.Faye=function(){function t(){}return t.prototype.subscriptions=[],t.prototype.connect=function(){return this.client=new window.Faye.Client(Sync.FAYE_HOST)},t.prototype.isConnected=function(){var t;return"CONNECTED"===(null!=(t=this.client)?t.getState():void 0)},t.prototype.subscribe=function(t,e){var n;return n=new Sync.Faye.Subscription(this.client,t,e),this.subscriptions.push(n),n},t.prototype.unsubscribeAll=function(){var t,e,n,r;for(n=this.subscriptions,t=0,e=n.length;e>t;t++)r=n[t],r.cancel();return this.subscriptions=[]},t}(),Sync.Faye.Subscription=function(){function t(t,e,n){this.client=t,this.fayeSub=this.client.subscribe(e,n)}return t.prototype.cancel=function(){return this.fayeSub.cancel()},t}(),Sync.Pusher=function(){function t(){}return t.prototype.subscriptions=[],t.prototype.connect=function(){return this.client=new window.Pusher(Sync.PUSHER_API_KEY)},t.prototype.isConnected=function(){var t;return"connected"===(null!=(t=this.client)?t.connection.state:void 0)},t.prototype.subscribe=function(t,e){var n;return n=new Sync.Pusher.Subscription(this.client,t,e),this.subscriptions.push(n),n},t.prototype.unsubscribeAll=function(){var t,e,n,r;for(n=this.subscriptions,t=0,e=n.length;e>t;t++)r=n[t],r.cancel();return this.subscriptions=[]},t}(),Sync.Pusher.Subscription=function(){function t(t,e,n){this.client=t,this.pusherSub=e,e=this.client.subscribe(e),e.bind("sync",n)}return t.prototype.cancel=function(){return null!=this.client.channel(this.pusherSub)?this.client.unsubscribe(this.pusherSub):void 0},t}(),Sync.View=function(){function t(t,e){this.$el=t,this.name=e}return t.prototype.removed=!1,t.prototype.beforeUpdate=function(t,e){return this.update(t)},t.prototype.afterUpdate=function(){},t.prototype.beforeInsert=function(t,e){return this.insert(t)},t.prototype.afterInsert=function(){},t.prototype.beforeRemove=function(){return this.remove()},t.prototype.afterRemove=function(){},t.prototype.isRemoved=function(){return this.removed},t.prototype.remove=function(){return this.$el.remove(),this.$el=$(),this.removed=!0,this.afterRemove()},t.prototype.bind=function(){},t.prototype.show=function(){return this.$el.show()},t.prototype.update=function(t){var e;return e=$($.trim(t)),this.$el.replaceWith(e),this.$el=e,this.afterUpdate(),this.bind()},t.prototype.insert=function(t){return this.$el.replaceWith(t),this.$el=t,this.afterInsert(),this.bind()},t}(),Sync.Partial=function(){function t(t){var e,n,r,i;null==t&&(t={}),r=this.attributes;for(n in r)e=r[n],this[n]=null!=(i=t[n])?i:e;this.$start=$("[data-sync-id='"+this.selectorStart+"']"),this.$end=$("[data-sync-id='"+this.selectorEnd+"']"),this.$el=this.$start.nextUntil(this.$end),this.view=new(Sync.viewClassFromPartialName(this.name,this.resourceName))(this.$el,this.name),this.adapter=Sync.adapter}return t.prototype.attributes={name:null,resourceName:null,resourceId:null,authToken:null,channelUpdate:null,channelDestroy:null,selectorStart:null,selectorEnd:null,refetch:!1,subscriptionUpdate:null,subscriptionDestroy:null},t.prototype.subscribe=function(){return this.subscriptionUpdate=this.adapter.subscribe(this.channelUpdate,function(t){return function(e){return t.refetch?t.refetchFromServer(function(e){return t.update(e)}):t.update(e.html)}}(this)),this.subscriptionDestroy=this.adapter.subscribe(this.channelDestroy,function(t){return function(){return t.remove()}}(this))},t.prototype.update=function(t){return this.view.beforeUpdate(t,{})},t.prototype.remove=function(){return this.view.beforeRemove(),this.view.isRemoved()?this.destroy():void 0},t.prototype.insert=function(t){return this.refetch?this.refetchFromServer(function(t){return function(e){return t.view.beforeInsert($($.trim(e)),{})}}(this)):this.view.beforeInsert($($.trim(t)),{})},t.prototype.destroy=function(){var t;return this.subscriptionUpdate.cancel(),this.subscriptionDestroy.cancel(),this.$start.remove(),this.$end.remove(),null!=(t=this.$el)&&t.remove(),delete this.$start,delete this.$end,delete this.$el},t.prototype.refetchFromServer=function(t){return $.ajax({type:"GET",url:"/sync/refetch.json",data:{auth_token:this.authToken,partial_name:this.name,resource_name:this.resourceName,resource_id:this.resourceId},success:function(e){return t(e.html)}})},t}(),Sync.PartialCreator=function(){function t(t){var e,n,r,i;null==t&&(t={}),r=this.attributes;for(n in r)e=r[n],this[n]=null!=(i=t[n])?i:e;this.$el=$("[data-sync-id='"+this.selector+"']"),this.adapter=Sync.adapter}return t.prototype.attributes={name:null,resourceName:null,authToken:null,channel:null,selector:null,direction:"append",refetch:!1},t.prototype.subscribe=function(){return this.adapter.subscribe(this.channel,function(t){return function(e){return t.insert(e.html,e.resourceId,e.authToken,e.channelUpdate,e.channelDestroy,e.selectorStart,e.selectorEnd)}}(this))},t.prototype.insertPlaceholder=function(t){switch(this.direction){case"append":return this.$el.before(t);case"prepend":return this.$el.after(t)}},t.prototype.insert=function(t,e,n,r,i,s,o){var u;return this.insertPlaceholder("<script type='text/javascript' data-sync-id='"+s+"'></script>\n<script type='text/javascript' data-sync-el-placeholder></script>\n<script type='text/javascript' data-sync-id='"+o+"'></script>"),u=new Sync.Partial({name:this.name,resourceName:this.resourceName,resourceId:e,authToken:n,channelUpdate:r,channelDestroy:i,selectorStart:s,selectorEnd:o,refetch:this.refetch}),u.subscribe(),u.insert(t)},t}(),Sync.init()}).call(this);